<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tiến độ học Flashcard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .chart-container {
        width: 80%;
        max-width: 600px;
      }
      h2 {
        margin-bottom: 2rem;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">Flashcard App</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="index.html">Trang Chủ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="daily_goal.html">Mục Tiêu Hàng Ngày</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="userDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Tài Khoản
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="userDropdown"
              >
                <li>
                  <a class="dropdown-item" href="profile.html" id="userNameLink"
                    >Profile</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" id="logoutBtn">Đăng xuất</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="d-flex justify-content-center align-items-center py-5">
      <h2 id="boTitle">Tiến độ học Flashcard</h2>
      <div class="chart-container">
        <canvas id="progressChart"></canvas>
      </div>
    </div>

    <script>
      const API_BASE = "http://127.0.0.1:8000";
      const params = new URLSearchParams(window.location.search);
      const bo_id = params.get("bo_id");
      const user = JSON.parse(localStorage.getItem("user"));

      // ===================== USER LOGIN + LOGOUT =====================

      if (!user) {
        alert("Vui lòng đăng nhập!");
        window.location.href = "login.html"; // chuyển về trang login
      }

      // Dropdown user & logout
      const userNameLink = document.getElementById("userNameLink");
      const logoutBtn = document.getElementById("logoutBtn");
      if (userNameLink) userNameLink.textContent = user.email || "Profile";

      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("user");
          window.location.href = "login.html";
        });
      }

      async function loadProgress() {
        try {
          // Lấy tên bộ flashcard
          const resBo = await fetch(`${API_BASE}/bo-flashcard/${bo_id}`);
          const bo = await resBo.json();
          document.getElementById(
            "boTitle"
          ).textContent = `Tiến độ học: ${bo.ten}`;

          // Lấy tất cả flashcard trong bộ
          const resFlashcards = await fetch(
            `${API_BASE}/flashcard/bo/${bo_id}`
          );
          const flashcards = await resFlashcards.json();

          // Lấy tiến độ học người dùng
          const resHoc = await fetch(`${API_BASE}/hoc/${user.id}`);
          const tienDoList = await resHoc.json();

          // Tính số flashcard đã ôn / chưa ôn
          const flashcardIds = flashcards.map((f) => f.id);
          const reviewedCount = tienDoList.filter(
            (td) => flashcardIds.includes(td.flashcard_id) && td.so_lan_on > 0
          ).length;
          const notReviewedCount = flashcards.length - reviewedCount;

          // Vẽ biểu đồ
          const ctx = document.getElementById("progressChart").getContext("2d");
          new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Đã ôn", "Chưa ôn"],
              datasets: [
                {
                  label: "Tiến độ học",
                  data: [reviewedCount, notReviewedCount],
                  backgroundColor: ["#0d6efd", "#ffc107"],
                  borderColor: ["#0a58ca", "#ffcd39"],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "bottom",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return context.label + ": " + context.raw + " flashcard";
                    },
                  },
                },
              },
            },
          });
        } catch (err) {
          alert("Lỗi khi tải tiến độ: " + err);
        }
      }

      loadProgress();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
